# sql_queries.yaml

queries:
  - name: "Type Findings"
    query: |
      SELECT DISTINCT RepoName,Type, COUNT(*) as count
      FROM Findings
      GROUP BY RepoName,Type;
  - name: "Cloud Service SDKs Used"
    query: |
      SELECT DISTINCT RepoName,Name
        FROM Findings
        WHERE Type = "Cloud Service SDK";
  - name: "Applications"
    query: |
      SELECT DISTINCT RepoName,Name
        FROM Findings
        WHERE Type = "Application";
  - name: "Docker Ports Detected"
    query: |
      SELECT DISTINCT  RepoName,json_extract(Properties, '$.arguments') AS Port
      FROM Findings
      WHERE Type = 'Docker Directive' AND Name = 'EXPOSE'
      ORDER BY Port;
  - name: "Docker Images Detected"
    query: |
      SELECT DISTINCT
          json_extract(Properties, '$.image') AS Image,
          json_extract(Properties, '$.version') AS Version
      FROM Findings
      WHERE Type = 'Docker Directive'
        AND json_extract(Properties, '$.image') IS NOT NULL;
  - name: "Libs and Versions Detected"
    query: |
      SELECT 
        RepoName,
        Name,
        json_extract(Properties, '$.Language') AS Language,
        GROUP_CONCAT(DISTINCT json_extract(Properties, '$.Version')) AS Versions
      FROM Findings
      WHERE Type = 'Library'
      GROUP BY RepoName, Name, Language
      ORDER BY Name;
  - name: "Frameworks Detected"
    query: |
      SELECT DISTINCT 
        RepoName,
        Name,
        Category
      FROM Findings
      WHERE Type = 'Framework'
      ORDER BY RepoName,Name;
  - name: "Git Stats"
    query: |
      SELECT
      RepoName,
      Name,
      MAX(
        CAST(
          COALESCE(
            json_extract(Properties, '$.value'),
            json_extract(Properties, '$.size'),
            json_extract(Properties, '$.commits_touched'),
            json_extract(Properties, '$.churn'),
            json_extract(Properties, '$.contributors'),
            json_extract(Properties, '$.max_lines_added')
          ) AS INTEGER
        )
      ) AS Metric
      FROM Findings
      WHERE Type = 'git_metric'
      GROUP BY RepoName,Name
      ORDER BY RepoName,Name;
  - name: "Terraform Resources Detected"
    query: |
      SELECT
        json_extract(Properties, '$.resource_type') AS resource_type,
        COUNT(*) AS count
      FROM Findings
      WHERE Type = "Terraform Resource Use"
      GROUP BY resource_type;
  - name: "Azure Resources Detected"
    query: |
      SELECT
          json_extract(Properties, '$.resource') AS resource_type,
          COUNT(*) AS count
      FROM Findings
      WHERE Type = "Azure Bicep"
      GROUP BY resource_type;
  - name: "Cloud Formation Detected"
    query: |
      SELECT
          RepoName,
          Name,
          COUNT(*) AS count
      FROM Findings
      WHERE Type = "CloudFormation Resource"
      GROUP BY RepoName, Name;
  - name: "Library Version Detection"
    query: |
      SELECT
        Name,
        Language,
        GROUP_CONCAT(Version, ', ') AS Versions,
        COUNT(*) AS Count
      FROM (
        SELECT DISTINCT
          Name,
          json_extract(Properties, '$.Language') AS Language,
          json_extract(Properties, '$.Version') AS Version
        FROM Findings
        WHERE Type = 'Library'
      )
      GROUP BY Name, Language
      HAVING COUNT(*) > 1;
  - name: "MS Office Files"
    query: |
      select Type, Category, Count(*)
      from Findings
      where Type = "MS Office"
      group by Type, Category;

